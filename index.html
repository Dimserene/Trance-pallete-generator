<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trance Palette Generator</title> <!-- Default title -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include Spectrum CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    <script>
        // Array of possible titles
        const titles = [
            "Trance Palette Generator",
            "Trance Theme Maker",
            "Trance Palette Creator",
            "Trance Color Designer",
            "Trance Theme Builder",
            "Trance Shade Generator",
            "Trance Palette Wizard",
            "Trance Theme Customizer",
            "Trance Style Generator",
            "Trance Color Schemer",
            "Trance Theme Designer",
            "Trance Shade Builder",
            "Trance Palette Tool",
            "Trance Hue Designer",
            "Trance Color Toolkit",
            "Trance Style Creator",
            "Trance Theme Wizard",
            "Trance Tint Generator",
            "Trance Shade Customizer",
            "Trance Palette Mixer",
            "Trance Theme Artist",
            "Trance Color Maker",
            "Trance Design Studio",
            "Trance Theme Lab",
            "Trance Hue Creator",
            "Trance Palette Studio",
            "Trance Style Maker",
            "Trance Theme Painter",
            "Trance Shade Artist",
            "Trance Color Blender",
            "Trance Hue Generator",
            "Trance Theme Composer",
            "Trance Palette Designer",
            "Trance Tint Maker",
            "Trance Color Editor",
            "Trance Style Builder",
            "Trance Theme Schemer",
            "Trance Shade Designer",
            "Trance Palette Builder",
            "Trance Color Crafter",
            "Trance Theme Crafter",
            "Trance Hue Maker",
            "Trance Style Editor",
            "Trance Palette Crafter",
            "Trance Shade Schemer",
            "Trance Theme Toolkit",
            "Trance Color Wizard",
            "Trance Palette Editor",
            "Trance Design Creator",
            "Trance Style Wizard",
            "Trance Tint Designer",
            "Trance Theme Blender",
            "Trance Hue Wizard",
            "Trance Shade Mixer",
            "Trance Color Artist",
            "Trance Theme Editor",
            "Trance Palette Crafter",
            "Trance Shade Maker",
            "Trance Hue Builder",
            "Trance Color Creator",
            "Trance Style Schemer",
            "Trance Theme Mixer",
            "Trance Tint Crafter",
            "Trance Color Builder",
            "Trance Design Generator",
            "Trance Style Studio",
            "Trance Hue Editor",
            "Trance Color Schemer",
            "Trance Palette Mixer",
            "Trance Theme Creator",
            "Trance Hue Artist",
            "Trance Tint Builder",
            "Trance Style Composer",
            "Trance Theme Composer",
            "Trance Shade Editor",
            "Trance Palette Crafter",
            "Trance Tint Creator",
            "Trance Style Mixer",
            "Trance Hue Crafter",
            "Trance Palette Wizard",
            "Trance Color Composer",
            "Trance Theme Creator",
            "Trance Shade Builder",
            "Trance Tint Wizard",
            "Trance Design Studio",
            "Trance Color Mixer",
            "Trance Style Painter",
            "Trance Theme Tool",
            "Trance Hue Mixer",
            "Trance Palette Tool",
            "Trance Tint Maker",
            "Trance Color Painter",
            "Trance Shade Wizard",
            "Trance Style Tool",
            "Trance Design Builder",
            "Trance Theme Crafter",
            "Trance Hue Designer",
            "Trance Tint Schemer",
            "Trance Shade Creator",
            "Trance Color Builder"
        ];

        // Function to randomly select a title
        function setRandomTitle() {
            const randomTitle = titles[Math.floor(Math.random() * titles.length)];
            document.title = randomTitle; // Set the page title
            document.getElementById("pageTitle").innerText = randomTitle; // Set the h1 title
        }

        // Run the function on page load
        window.onload = setRandomTitle;
    </script>
    <style>
        /* Base CSS Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding-bottom: 60px; /* Add bottom padding to prevent content from being covered */
        }
        h1 {
            text-align: center;
            padding: 0.5em;
            background-color: #374244;
            color: #ffffff;
            margin: 0;
            font-size: 1.5em;
        }
        #colorContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5em;
        }
        .category {
            width: 100%;
            max-width: 1200px;
            margin: 0.5em 0;
            background-color: #ffffff;
            border-radius: 4px;
            box-sizing: border-box;
            padding: 0.5em;
            display: block; /* Ensure block display */
        }
        .category h2 {
            margin: 1em 0 0.5em 0;
            font-size: 1.2em;
            text-align: left;
            border-bottom: 1px solid #ccc;
            padding-bottom: 0.25em;
            display: block; /* Ensure block display */
            width: 100%; /* Ensure it takes full width */
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5em;
        }
        .color-item {
            display: flex;
            flex-direction: column; /* Adjusted to column to include comments */
            align-items: flex-start; /* Align items to the start */
            padding: 0.25em;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .color-name {
            font-size: 0.9em;
            overflow-wrap: break-word; /* Break long words */
            margin-bottom: 0.25em; /* Add margin below for spacing */
            font-weight: bold;
        }
        .color-comment {
            font-size: 0.8em;
            color: #555;
            margin-top: 0.5em; /* Adjusted margin */
        }
        .controls-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls-container > * {
            flex: 0 0 auto;
            margin-right: 0.25em;
            margin-bottom: 0.25em; /* Add margin for wrapping */
        }
        .color-original,
        .arrow,
        .color-picker {
            width: 1.2em;
            height: 1.2em;
        }
        .hex-input {
            width: 5em;
            padding: 0.2em;
            font-size: 0.8em;
            border: 1px solid #cccccc;
            border-radius: 2px;
            text-transform: uppercase;
        }
        .reset-button {
            width: 1.2em;
            height: 1.2em;
            background: url('https://raw.githubusercontent.com/Dimserene/Trance-pallete-generator/main/reset.png') no-repeat center;
            background-size: contain;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 0.25em;
        }
        #resetAllButton,
        #exportLuaButton,
        #importTextButton,
        #downloadLuaButton {
            display: inline-block;
            margin: 0.5em;
            padding: 0.5em 1em;
            font-size: 1em;
            background-color: #374244;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #resetAllButton:hover,
        #exportLuaButton:hover,
        #importTextButton:hover,
        #downloadLuaButton:hover {
            background-color: #4f6367;
        }
        #exportLuaOutput {
            width: calc(100% - 1em);
            max-width: 1200px;
            height: 250px;
            margin: 0.5em auto;
            display: block;
            font-family: monospace;
            padding: 0.5em;
            box-sizing: border-box;
            border: 1px solid #cccccc;
            border-radius: 4px;
            resize: vertical;
        }
        /* Footer Styles */
        footer {
            text-align: center;
            padding: 5px;
            background-color: #374244;
            color: white;
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
        }
        footer a {
            color: #ffd700;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        /* Style for the "Jump to Top" button inside the footer */
        #scrollTopButton {
            display: none; /* Hidden by default */
            position: fixed;
            bottom: 40px; /* Adjust as needed */
            right: 30px;
            z-index: 99;
            font-size: 18px;
            border: none;
            outline: none;
            background-color: #4f6367;
            color: #ffffff;
            cursor: pointer;
            padding: 15px;
            border-radius: 4px;
        }
        
        #scrollTopButton:hover {
            background-color: #555;
        }
        /* Mobile Styles */
        @media (max-width: 600px) {
            .category {
                padding: 0.25em;
                display: block; /* Ensure block display */
            }
            .category h2 {
                font-size: 1em;
                margin: 1em 0 0.25em 0; /* Add top margin */
                padding-bottom: 0.25em;
                display: block; /* Ensure block display */
                width: 100%; /* Ensure it takes full width */
            }
            .color-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.25em;
            }
            .color-item {
                padding: 0.25em;
                align-items: flex-start;
            }
            .color-name {
                font-size: 0.8em;
                margin-bottom: 0.25em;
            }
            .color-comment {
                font-size: 0.7em;
                margin-bottom: 0.25em;
            }
            .controls-container > * {
                margin-right: 0.25em;
                margin-bottom: 0.25em;
            }
            .color-original,
            .arrow,
            .color-picker,
            .reset-button {
                width: 1em;
                height: 1em;
            }
            .hex-input {
                width: 4em;
            }
            #resetAllButton,
            #exportLuaButton,
            #importTextButton,
            #downloadLuaButton {
                margin: 0.25em;
                padding: 0.5em 1em;
            }
            #exportLuaOutput {
                height: 200px;
                margin: 0.25em auto;
            }
            footer {
                padding: 0px;
                font-size: 0.8em;
            }
            /* Adjust the "Jump to Top" button in the footer on mobile */
            #scrollTopButton {
                margin-top: 5px;
                padding: 5px 5px;
            }
        }
    </style>
</head>
<body>

    <h1 id="pageTitle">Trance Palette Generator</h1> <!-- Default title for heading -->

    <div style="text-align: center;">
        <button id="resetAllButton">Reset All</button>
        <button id="exportLuaButton">Export</button>
        <button id="importTextButton">Import from Text</button>
        <button id="downloadLuaButton">Download Lua File</button>
    </div>
    <textarea id="exportLuaOutput" placeholder="Paste, edit, or export your Lua code here..."></textarea>
    
    <div id="colorContainer"></div>

    <!-- Footer with Trance Mod Link, Credits -->
    <footer>
        <p>
            <a href="https://github.com/MathIsFun0/Trance" target="_blank">Download Trance</a>
                | 
                Page Created by Dimserene
        </p>
    </footer>

    <button id="scrollTopButton" title="Go to top">Top</button>

    <!-- Include jQuery (Spectrum dependency) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Spectrum JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
    <script>
        // Updated color data with individual comments for array items and display names for categories
        const defaultColorData = [
            {
                key: 'SPLASH',
                displayName: 'Title Screen/Boss Screen swirl Color',
                value: [
                    { value: 'FE5F55', comment: 'Splash Color 1' },
                    { value: '009DFF', comment: 'Splash Color 2' }
                ],
                comment: 'Title Screen / Boss Screen colors'
            },
            {
                key: 'MULT',
                value: 'FE5F55',
                comment: 'Color of the Multiplier half of the score equation'
            },
            {
                key: 'CHIPS',
                value: '009DFF',
                comment: 'Color of the Chips half of the score equation'
            },
            {
                key: 'PLASMA',
                value: 'CC73D9',
                comment: 'Color of both halves when score is balanced by Plasma Deck'
            },
            {
                key: 'MONEY',
                value: 'F3B958',
                comment: 'Color of current Money ($)'
            },
            {
                key: 'XMULT',
                value: 'FE5F55',
                comment: 'Background of Xmult in joker descriptions'
            },
            {
                key: 'FILTER',
                value: 'FF9A00',
                comment: 'Used for important elements like filters'
            },
            {
                key: 'BLUE',
                value: '009DFF',
                comment: 'Color for Blue chips'
            },
            {
                key: 'RED',
                value: 'FE5F55',
                comment: 'Color for Red chips'
            },
            {
                key: 'GREEN',
                value: '4BC292',
                comment: 'Base background color'
            },
            {
                key: 'PALE_GREEN',
                value: '56A887',
                comment: 'Background accent color'
            },
            {
                key: 'ORANGE',
                value: 'FDA200',
                comment: 'Color of some options (on main menu, Options button)'
            },
            {
                key: 'IMPORTANT',
                value: 'FF9A00',
                comment: 'Accent color of joker cards (such as designated hand)'
            },
            {
                key: 'GOLD',
                value: 'EAC058',
                comment: 'Money when described in a joker description'
            },
            {
                key: 'YELLOW',
                value: 'FFFF00',
                comment: 'General yellow color'
            },
            {
                key: 'CLEAR',
                value: '00000000',
                comment: 'Transparent color (e.g. glass cards)'
            },
            {
                key: 'WHITE',
                value: 'FFFFFF',
                comment: 'Pure white color, used in important highlights'
            },
            {
                key: 'PURPLE',
                value: '8867A5',
                comment: 'Color for Tarot cards'
            },
            {
                key: 'BLACK',
                value: '374244',
                comment: 'Black color'
            },
            {
                key: 'L_BLACK',
                value: '4F6367',
                comment: 'Light black color'
            },
            {
                key: 'GREY',
                value: '5F7377',
                comment: 'Grey color'
            },
            {
                key: 'CHANCE',
                value: '4BC292',
                comment: 'Probability color'
            },
            {
                key: 'JOKER_GREY',
                value: 'BFC7D5',
                comment: 'Grey color for Joker text'
            },
            {
                key: 'VOUCHER',
                value: 'CB724C',
                comment: 'Background for Voucher text'
            },
            {
                key: 'BOOSTER',
                value: '646EB7',
                comment: 'Background for Booster text'
            },
            {
                key: 'ETERNAL',
                value: 'C75985',
                comment: 'Background for Eternal text'
            },
            {
                key: 'PERISHABLE',
                value: '4F5DA1',
                comment: 'Background for Perishable text'
            },
            {
                key: 'RENTAL',
                value: 'B18F43',
                comment: 'Background for Rental text'
            },
            {
                key: 'DYN_UI',
                displayName: 'Dynamic UI',
                value: [
                    { key: 'MAIN', value: '374244', comment: 'Dynamic UI main color' },
                    { key: 'DARK', value: '374244', comment: 'Dynamic UI dark color' },
                    { key: 'BOSS_MAIN', value: '374244', comment: 'Boss UI main color' },
                    { key: 'BOSS_DARK', value: '374244', comment: 'Boss UI dark color' },
                    { key: 'BOSS_PALE', value: '374244', comment: 'Boss UI pale color' }
                ],
                comment: 'Colors for dynamic UI elements'
            },
            {
                key: 'SO_1',
                displayName: 'High Contrast Suit Colors',
                value: [
                    { key: 'Hearts', value: 'F03464', comment: 'High contrast Hearts suit' },
                    { key: 'Diamonds', value: 'F06B3F', comment: 'High contrast Diamonds suit' },
                    { key: 'Spades', value: '403995', comment: 'High contrast Spades suit' },
                    { key: 'Clubs', value: '235955', comment: 'High contrast Clubs suit' }
                ],
                comment: 'High contrast suit colors'
            },
            {
                key: 'SO_2',
                displayName: 'Normal Suit Colors',
                value: [
                    { key: 'Hearts', value: 'F83B2F', comment: 'Normal Hearts suit' },
                    { key: 'Diamonds', value: 'E29000', comment: 'Normal Diamonds suit' },
                    { key: 'Spades', value: '4F31B9', comment: 'Normal Spades suit' },
                    { key: 'Clubs', value: '008EE6', comment: 'Normal Clubs suit' }
                ],
                comment: 'Normal suit colors'
            },
            {
                key: 'UI',
                displayName: 'UI Texts and Background Colors',
                value: [
                    { key: 'TEXT_LIGHT', value: 'FFFFFF', comment: 'Light text' },
                    { key: 'TEXT_DARK', value: '4F6367', comment: 'Dark text' },
                    { key: 'TEXT_INACTIVE', value: '88888899', comment: 'Inactive text' },
                    { key: 'BACKGROUND_LIGHT', value: 'B8D8D8', comment: 'Light background' },
                    { key: 'BACKGROUND_WHITE', value: 'FFFFFF', comment: 'White background' },
                    { key: 'BACKGROUND_DARK', value: '7A9E9F', comment: 'Dark background' },
                    { key: 'BACKGROUND_INACTIVE', value: '666666FF', comment: 'Inactive background' },
                    { key: 'OUTLINE_LIGHT', value: 'D8D8D8', comment: 'Light outline' },
                    { key: 'OUTLINE_LIGHT_TRANS', value: 'D8D8D866', comment: 'Light translucent outline' },
                    { key: 'OUTLINE_DARK', value: '7A9E9F', comment: 'Dark outline' },
                    { key: 'TRANSPARENT_LIGHT', value: 'EEEEEE22', comment: 'Light transparency' },
                    { key: 'TRANSPARENT_DARK', value: '22222222', comment: 'Dark transparency' },
                    { key: 'HOVER', value: '00000055', comment: 'Hover color' }
                ],
                comment: 'UI Text and Background Colors'
            },
            {
                key: 'SET',
                displayName: 'Background Colors for Card Sets',
                value: [
                    { value: 'CDD9DC', comment: 'Default set color' },
                    { value: 'CDD9DC', comment: 'Enhanced set color' },
                    { value: '424E54', comment: 'Joker set color' },
                    { value: '424E54', comment: 'Tarot set color' },
                    { value: '424E54', comment: 'Planet set color' },
                    { value: '424E54', comment: 'Spectral set color' },
                    { value: '424E54', comment: 'Voucher set color' }
                ],
                comment: 'Background colors for card sets'
            },
            {
                key: 'SECONDARY_SET',
                displayName: 'Secondary Background Color for Card Set',
                value: [
                    { value: '9BB6BDFF', comment: 'Default secondary color' },
                    { value: '8389DDFF', comment: 'Enhanced secondary color' },
                    { value: '708B91', comment: 'Joker secondary color' },
                    { value: 'A782D1', comment: 'Tarot secondary color' },
                    { value: '13AFCE', comment: 'Planet secondary color' },
                    { value: '4584FA', comment: 'Spectral secondary color' },
                    { value: 'FD682B', comment: 'Voucher secondary color' },
                    { value: '4CA893', comment: 'Edition secondary color' }
                ],
                comment: 'Secondary background colors for certain cards'
            },
            {
                key: 'RARITY',
                value: [
                    { value: '009DFF', comment: 'Common' },
                    { value: '4BC292', comment: 'Uncommon' },
                    { value: 'FE5F55', comment: 'Rare' },
                    { value: 'B26CBB', comment: 'Legendary' }
                ],
                comment: 'Rarity colors'
            },
            {
                key: 'BLIND',
                value: [
                    { key: 'Small', value: '50846E', comment: 'Small blind color' },
                    { key: 'Big', value: '50846E', comment: 'Big blind color' },
                    { key: 'Boss', value: 'B44430', comment: 'Boss blind color' },
                    { key: 'won', value: '4F6367', comment: 'Blind won color' }
                ],
                comment: 'Blind colors'
            },
            {
                key: 'HAND_LEVELS',
                value: [
                    { value: 'EFEFEF', comment: 'Hand Level 1' },
                    { value: '95ACFF', comment: 'Hand Level 2' },
                    { value: '65EFAF', comment: 'Hand Level 3' },
                    { value: 'FAE37E', comment: 'Hand Level 4' },
                    { value: 'FFC052', comment: 'Hand Level 5' },
                    { value: 'F87D75', comment: 'Hand Level 6' },
                    { value: 'CAA0EF', comment: 'Hand Level 7+' }
                ],
                comment: 'Hand level progression colors'
            },
            {
                key: 'BACKGROUND',
                displayName: 'Background Colors',
                value: [
                    { key: 'L', value: 'FFFF00', comment: 'Background Light' },
                    { key: 'D', value: '374244', comment: 'Background Dark' },
                    { key: 'C', value: '374244', comment: 'Background Contrast' }
                ],
                comment: 'Background colors'
            },
            {
                key: 'BOSSES',
                displayName: 'Bosses Colors (does not affect background color)',
                value: [
                    { key: 'bl_ox', value: 'B95B08', comment: 'Boss color for The ox' },
                    { key: 'bl_hook', value: 'A84024', comment: 'Boss color for The hook' },
                    { key: 'bl_mouth', value: 'AE718E', comment: 'Boss color for The mouth' },
                    { key: 'bl_fish', value: '3E85BD', comment: 'Boss color for The fish' },
                    { key: 'bl_club', value: 'B9CB92', comment: 'Boss color for The club' },
                    { key: 'bl_manacle', value: '575757', comment: 'Boss color for The manacle' },
                    { key: 'bl_tooth', value: 'B52D2D', comment: 'Boss color for The tooth' },
                    { key: 'bl_wall', value: '8A59A5', comment: 'Boss color for The wall' },
                    { key: 'bl_house', value: '5186A8', comment: 'Boss color for The house' },
                    { key: 'bl_mark', value: '6A3847', comment: 'Boss color for The mark' },
                    { key: 'bl_wheel', value: '50BF7C', comment: 'Boss color for The wheel' },
                    { key: 'bl_arm', value: '6865F3', comment: 'Boss color for The arm' },
                    { key: 'bl_psychic', value: 'EFC03C', comment: 'Boss color for The psychic' },
                    { key: 'bl_goad', value: 'B95C96', comment: 'Boss color for The goad' },
                    { key: 'bl_water', value: 'C6E0EB', comment: 'Boss color for The water' },
                    { key: 'bl_eye', value: '4B71E4', comment: 'Boss color for The eye' },
                    { key: 'bl_plant', value: '709284', comment: 'Boss color for The plant' },
                    { key: 'bl_needle', value: '5C6E31', comment: 'Boss color for The needle' },
                    { key: 'bl_head', value: 'AC9DB4', comment: 'Boss color for The head' },
                    { key: 'bl_window', value: 'A9A295', comment: 'Boss color for The window' },
                    { key: 'bl_serpent', value: '439A4F', comment: 'Boss color for The serpent' },
                    { key: 'bl_pillar', value: '7E6752', comment: 'Boss color for The pillar' },
                    { key: 'bl_flint', value: 'E56A2F', comment: 'Boss color for The flint' },
                    { key: 'bl_final_bell', value: '009CFD', comment: 'Boss color for final bell' },
                    { key: 'bl_final_leaf', value: '56A786', comment: 'Boss color for final leaf' },
                    { key: 'bl_final_vessel', value: '8A71E1', comment: 'Boss color for final vessel' },
                    { key: 'bl_final_acorn', value: 'FDA200', comment: 'Boss color for final acorn' },
                    { key: 'bl_final_heart', value: 'AC3232', comment: 'Boss color for final heart' }
                ],
                comment: 'Boss-specific colors'
            }
        ];

        // Copy of color data that will be modified
        let colorData = JSON.parse(JSON.stringify(defaultColorData));

        // Store references to Spectrum instances
        let spectrumInstances = [];

        // Function to create color pickers using Spectrum
        function createColorPickers(dataArray, container, defaultDataArray) {
            // Clear the container to prevent duplicates
            container.innerHTML = '';
            
            // Reset the spectrumInstances array
            spectrumInstances = [];
            
            const mainCategory = { key: 'Main', items: [] };
            const levelsCategory = { key: 'Levels and Rarity', items: [] };
            const categories = [];

            dataArray.forEach((item, index) => {
                const key = item.key;
                const value = item.value;
                const comment = item.comment || '';
                const defaultItem = defaultDataArray ? defaultDataArray[index] : null;

                if (key === 'RARITY' || key === 'HAND_LEVELS') {
                    // Group RARITY and HAND_LEVELS under "Levels and Rarity"
                    levelsCategory.items.push({
                        key: key,
                        value: value,
                        comment: comment,
                        dataArray: dataArray,
                        dataIndex: index,
                        defaultValue: defaultItem ? defaultItem.value : value
                    });
                } else if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object' && value[0].hasOwnProperty('value')) {
                    // Nested category with array of objects
                    categories.push({
                        key: key,
                        value: value,
                        comment: comment,
                        defaultValue: defaultItem ? defaultItem.value : []
                    });
                } else {
                    // Unclassified color or array of colors
                    mainCategory.items.push({
                        key: key,
                        value: value,
                        comment: comment,
                        dataArray: dataArray,
                        dataIndex: index,
                        defaultValue: defaultItem ? defaultItem.value : value
                    });
                }
            });

            // Display Main category if it has items
            if (mainCategory.items.length > 0) {
                createCategoryDiv(mainCategory, container);
            }

            // Display Levels and Rarity category if it has items
            if (levelsCategory.items.length > 0) {
                createCategoryDiv(levelsCategory, container);
            }

            // Now process other categories
            categories.forEach(category => {
                const defaultSubData = category.defaultValue;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';

                const categoryTitle = document.createElement('h2');
                categoryTitle.textContent = category.displayName || category.key;
                categoryDiv.appendChild(categoryTitle);

                const colorGrid = document.createElement('div');
                colorGrid.className = 'color-grid';

                category.value.forEach((subItem, subIndex) => {
                    const subKey = subItem.key || `${category.key}[${subIndex}]`;
                    const subValue = subItem.value;
                    const subComment = subItem.comment || '';
                    const defaultSubItem = defaultSubData ? defaultSubData[subIndex] : null;

                    if (typeof subValue === 'string') {
                        const defaultColorValue = defaultSubItem ? defaultSubItem.value || 'FFFFFF' : 'FFFFFF';
                        createColorItem(subValue, subKey, category.value, subIndex, colorGrid, defaultColorValue, subComment);
                    }
                });

                categoryDiv.appendChild(colorGrid);
                container.appendChild(categoryDiv);
            });
        }

        function createCategoryDiv(categoryObj, container) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';

            const categoryTitle = document.createElement('h2');
            categoryTitle.textContent = categoryObj.displayName || categoryObj.key;
            categoryDiv.appendChild(categoryTitle);

            const colorGrid = document.createElement('div');
            colorGrid.className = 'color-grid';

            categoryObj.items.forEach(item => {
                if (Array.isArray(item.value) && item.value.length > 0 && typeof item.value[0] === 'object' && item.value[0].hasOwnProperty('value')) {
                    // Array of objects with value and comment
                    const defaultArrayData = item.defaultValue || [];
                    item.value.forEach((colorItem, idx) => {
                        const colorValue = colorItem.value;
                        const subComment = colorItem.comment || '';
                        const defaultColorValue = defaultArrayData[idx] ? defaultArrayData[idx].value || 'FFFFFF' : 'FFFFFF';
                        const displayName = `${item.key}[${idx}]`;
                        createColorItem(colorValue, displayName, item.value, idx, colorGrid, defaultColorValue, subComment);
                    });
                } else if (typeof item.value === 'string') {
                    // Single color value
                    const defaultColorValue = item.defaultValue || 'FFFFFF';
                    createColorItem(item.value, item.key, item.dataArray, item.dataIndex, colorGrid, defaultColorValue, item.comment);
                }
            });

            categoryDiv.appendChild(colorGrid);
            container.appendChild(categoryDiv);
        }

        function createColorItem(colorValue, displayName, parentDataArray, dataIndex, container, defaultColorValue, comment = '') {
            // Provide a default value if defaultColorValue is undefined
            defaultColorValue = defaultColorValue || 'FFFFFF';
        
            const colorItem = document.createElement('div');
            colorItem.className = 'color-item';
        
            const colorName = document.createElement('div');
            colorName.className = 'color-name';
            colorName.textContent = displayName;
        
            colorItem.appendChild(colorName);
        
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'controls-container';
        
            const colorOriginal = document.createElement('div');
            colorOriginal.className = 'color-original';
            colorOriginal.style.backgroundColor = '#' + defaultColorValue.slice(0, 6);
        
            const arrow = document.createElement('div');
            arrow.className = 'arrow';
            arrow.textContent = '→';
        
            // Create an input for Spectrum
            const colorInput = document.createElement('input');
            colorInput.type = 'text';
            colorInput.className = 'color-picker';
        
            // Set initial value (including alpha)
            let hexColor = colorValue.slice(0, 6).toUpperCase();
            let alpha = colorValue.length >= 8 ? parseInt(colorValue.slice(6, 8), 16) / 255 : 1;
        
            colorInput.value = '#' + colorValue.slice(0, 6);
        
            const hexInput = document.createElement('input');
            hexInput.type = 'text';
            hexInput.value = colorValue.toUpperCase();
            hexInput.className = 'hex-input';
            hexInput.maxLength = 8;
        
            // Reset Button
            const resetButton = document.createElement('button');
            resetButton.className = 'reset-button';
            resetButton.title = 'Reset to Default';
            resetButton.addEventListener('click', function() {
                // Reset data
                if (Array.isArray(parentDataArray)) {
                    if (typeof parentDataArray[dataIndex] === 'object') {
                        parentDataArray[dataIndex].value = defaultColorValue;
                    } else {
                        parentDataArray[dataIndex] = defaultColorValue;
                    }
                } else {
                    parentDataArray.value = defaultColorValue;
                }
                // Update Spectrum color picker
                const defaultHexColor = defaultColorValue.slice(0, 6).toUpperCase();
                const defaultAlpha = defaultColorValue.length >= 8 ? parseInt(defaultColorValue.slice(6, 8), 16) / 255 : 1;
                const defaultColorString = '#' + defaultHexColor + (defaultAlpha < 1 ? defaultColorValue.slice(6, 8) : '');
                $(colorInput).spectrum("set", defaultColorString);
                // Update hex input
                hexInput.value = defaultColorValue.toUpperCase();
            });
        
            // Append elements to controlsContainer
            controlsContainer.appendChild(colorOriginal);
            controlsContainer.appendChild(arrow);
            controlsContainer.appendChild(colorInput);
            controlsContainer.appendChild(hexInput);
            controlsContainer.appendChild(resetButton);
        
            // Append controlsContainer to colorItem
            colorItem.appendChild(controlsContainer);
        
            // Now append the comment after the controlsContainer
            if (comment) {
                const colorComment = document.createElement('div');
                colorComment.className = 'color-comment';
                colorComment.textContent = comment;
                colorItem.appendChild(colorComment);
            }
        
            // Append the colorItem to the container
            container.appendChild(colorItem);
        
            // Initialize Spectrum on the colorInput
            const spectrumInstance = $(colorInput).spectrum({
                color: '#' + hexColor + (alpha < 1 ? Math.round(alpha * 255).toString(16).padStart(2, '0') : ''),
                showInput: false,
                showInitial: false,
                preferredFormat: "hex8",
                showAlpha: true,
                move: function(tinycolor) {
                    const newHex8 = tinycolor.toHex8String().toUpperCase();
                    hexInput.value = newHex8.slice(1);
                    // Update colorData here on the color move
                    updateParentData(newHex8.slice(1));
                },
                change: function(tinycolor) {
                    const newHex8 = tinycolor.toHex8String().toUpperCase();
                    hexInput.value = newHex8.slice(1);
                    // Update colorData when the color picker changes
                    updateParentData(newHex8.slice(1));
                }
            });
        
            // Store reference for reset all functionality
            spectrumInstances.push({
                spectrumInstance: spectrumInstance,
                colorInput: colorInput,
                hexInput: hexInput,
                parentDataArray: parentDataArray,
                dataIndex: dataIndex,
                defaultColorValue: defaultColorValue
            });
        
            // Update function to modify colorData
            function updateParentData(newColor) {
                if (Array.isArray(parentDataArray)) {
                    if (typeof parentDataArray[dataIndex] === 'object') {
                        parentDataArray[dataIndex].value = newColor;
                    } else {
                        parentDataArray[dataIndex] = newColor;
                    }
                } else {
                    parentDataArray.value = newColor;
                }
            }
        
            function updateColor(newColor) {
                // Validate hex code or keyword
                if (/^[0-9A-Fa-f]{6,8}$/.test(newColor)) {
                    let colorString = '#' + newColor;
                    $(colorInput).spectrum("set", colorString);
                    updateParentData(newColor.toUpperCase());
                } else {
                    // Handle keyword input
                    let isDefault = false;
                    let key = newColor;
                    if (newColor.startsWith('$')) {
                        isDefault = true;
                        key = newColor.substring(1);
                    }
                    key = key.toUpperCase().trim(); // Make lookup case-insensitive
                    let lookupColor = lookupColorByKey(key, isDefault);
                    if (lookupColor) {
                        $(colorInput).spectrum("set", '#' + lookupColor);
                        hexInput.value = lookupColor.toUpperCase();
                        updateParentData(lookupColor.toUpperCase());
                    } else {
                        // If keyword doesn't exist, provide feedback
                        alert(`Keyword "${newColor}" not found.`);
                        // Reset to previous value
                        let currentHex = getCurrentHexValue();
                        hexInput.value = currentHex.toUpperCase();
                    }
                }
            }
        
            hexInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    const newInput = hexInput.value.trim().toUpperCase();
                    if (newInput !== '') {
                        updateColor(newInput);
                    }
                }
            });
        
            hexInput.addEventListener('blur', function() {
                const newInput = hexInput.value.trim().toUpperCase();
                if (newInput === '') {
                    // If empty, reset to current value
                    let currentHex = getCurrentHexValue();
                    hexInput.value = currentHex.toUpperCase();
                } else if (!/^[0-9A-Fa-f]{6,8}$/.test(newInput) && !isValidKeyword(newInput)) {
                    // If invalid, reset to current color value
                    let currentHex = getCurrentHexValue();
                    hexInput.value = currentHex.toUpperCase();
                } else if (newInput !== getCurrentHexValue().toUpperCase()) {
                    // If valid and different, update the color
                    updateColor(newInput);
                }
            });
        
            // Helper function to get current hex value from parentDataArray
            function getCurrentHexValue() {
                if (Array.isArray(parentDataArray)) {
                    if (typeof parentDataArray[dataIndex] === 'object') {
                        return parentDataArray[dataIndex].value;
                    } else {
                        return parentDataArray[dataIndex];
                    }
                } else {
                    return parentDataArray.value;
                }
            }
        
            // Helper function to check if input is a valid keyword
            function isValidKeyword(input) {
                let key = input.startsWith('$') ? input.substring(1) : input;
                key = key.toUpperCase();
                return doesKeyExist(key);
            }
        }

        // Initialize the color pickers
        const colorContainer = document.getElementById('colorContainer');
        createColorPickers(colorData, colorContainer, defaultColorData);

        // Reset All functionality
        document.getElementById('resetAllButton').addEventListener('click', function() {
            colorData = JSON.parse(JSON.stringify(defaultColorData));
            createColorPickers(colorData, document.getElementById('colorContainer'), defaultColorData);
        });

        // Export to Lua functionality
        document.getElementById('exportLuaButton').addEventListener('click', function() {
            const exportedLua = 'return ' + convertToLuaTable(colorData);
            document.getElementById('exportLuaOutput').value = exportedLua;
        });

        // Download Lua File functionality
        document.getElementById('downloadLuaButton').addEventListener('click', function() {
            const luaData = 'return ' + convertToLuaTable(colorData);
            const blob = new Blob([luaData], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'New_Theme.lua';
            link.click();
        });

        // Function to convert the array-based color data to Lua table format
        function convertToLuaTable(dataArray, indent = '', isRoot = true) {
            let lua = isRoot ? '{\n' : '{\n';
            const indent2 = indent + '    ';
            dataArray.forEach(item => {
                const key = item.key;
                const value = item.value;
                lua += indent2;
                if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
                    lua += key + ' = ';
                } else {
                    lua += '["' + key + '"] = ';
                }
                if (Array.isArray(value)) {
                    if (value.length > 0 && typeof value[0] === 'object' && value[0].hasOwnProperty('value')) {
                        // Array of objects with value and comment
                        lua += '{\n';
                        value.forEach(function(val) {
                            lua += indent2 + '    ';
                            if (val.key) {
                                if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(val.key)) {
                                    lua += val.key + ' = HEX(\'' + val.value + '\'),\n';
                                } else {
                                    lua += '["' + val.key + '"] = HEX(\'' + val.value + '\'),\n';
                                }
                            } else {
                                lua += 'HEX(\'' + val.value + '\'),\n';
                            }
                        });
                        lua += indent2 + '},\n';
                    } else {
                        lua += '{},\n';
                    }
                } else if (typeof value === 'string') {
                    lua += 'HEX(\'' + value + '\'),\n';
                } else {
                    lua += 'nil,\n';
                }
            });
            lua += indent + '}';
            return lua;
        }

        // Corrected Import from Text functionality
        document.getElementById('importTextButton').addEventListener('click', function() {
            const luaCode = document.getElementById('exportLuaOutput').value;
            try {
                const importedData = parseLuaPalette(luaCode);
                if (importedData) {
                    colorData = importedData;
                    createColorPickers(colorData, document.getElementById('colorContainer'), defaultColorData);
                } else {
                    alert('Failed to import palette. Invalid format.');
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred while importing the Lua code.');
            }
        });

        function parseLuaPalette(luaCode) {
            const hexPattern = /HEX\('([0-9A-Fa-f]{6,8})'\)/g;
            const keyPattern = /(\w+)\s*=\s*(\{[\s\S]*?\}|HEX\('([0-9A-Fa-f]{6,8})'\))/g;
        
            let parsedData = JSON.parse(JSON.stringify(defaultColorData));
            let match;
        
            while ((match = keyPattern.exec(luaCode)) !== null) {
                const key = match[1];
                const valueStr = match[2];
                const hexValue = match[3] || '';
        
                const item = parsedData.find(item => item.key === key);
                if (item) {
                    if (valueStr.startsWith('{')) {
                        // Handle nested array
                        const nestedHexPattern = /HEX'([0-9A-Fa-f]{6,8})'/g;
                        let nestedMatch;
                        const values = [];
                        while ((nestedMatch = nestedHexPattern.exec(valueStr)) !== null) {
                            values.push(nestedMatch[1]);
                        }
                        if (Array.isArray(item.value)) {
                            for (let i = 0; i < item.value.length; i++) {
                                if (values[i]) {
                                    if (typeof item.value[i] === 'object') {
                                        item.value[i].value = values[i];
                                    } else {
                                        item.value[i] = values[i];
                                    }
                                }
                            }
                        }
                    } else if (hexValue) {
                        // Handle single HEX value
                        item.value = hexValue;
                    }
                }
            }
        
            return parsedData;
        }
        
        // Add the scroll event listener to show/hide the "Top" button
        window.onscroll = function() { scrollFunction(); };
        
        function scrollFunction() {
            const scrollTopButton = document.getElementById("scrollTopButton");
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollTopButton.style.display = "block";
            } else {
                scrollTopButton.style.display = "none";
            }
        }
        
        // "Jump to Top" button functionality
        document.getElementById('scrollTopButton').addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Function to lookup color by key
        function lookupColorByKey(key, useDefault = false) {
            let dataArray = useDefault ? defaultColorData : colorData;
            let result = findColorInDataArray(dataArray, key);
            return result ? result.toUpperCase() : null;
        }
        
        // Recursive function to find color in data array
        function findColorInDataArray(dataArray, key) {
            for (let item of dataArray) {
                if (item.key && item.key.toUpperCase() === key) {
                    if (typeof item.value === 'string') {
                        return item.value;
                    } else if (Array.isArray(item.value)) {
                        // If the value is an array, you might decide how to handle it
                        // For simplicity, return null or handle nested keys
                        continue;
                    }
                } else if (Array.isArray(item.value)) {
                    // Check within nested arrays
                    let result = findColorInValueArray(item.value, key);
                    if (result) {
                        return result;
                    }
                }
            }
            return null;
        }
        
        // Function to find color in value array
        function findColorInValueArray(valueArray, key) {
            for (let val of valueArray) {
                if (val.key && val.key.toUpperCase() === key) {
                    if (typeof val.value === 'string') {
                        return val.value;
                    }
                }
            }
            return null;
        }
        
        // Function to check if a key exists
        function doesKeyExist(key) {
            return lookupColorByKey(key, true) !== null || lookupColorByKey(key, false) !== null;
        }
    </script>
</body>
</html>
