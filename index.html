<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trance Palette Generator v1.2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Mobile friendly -->
    <!-- Include Spectrum CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    <!-- Include Luaparse (Moved here to ensure it loads before any scripts that use it) -->
    <script src="https://cdn.jsdelivr.net/npm/luaparse@0.3.1/dist/luaparse.min.js"></script>
    <style>
        /* [Your existing CSS styles remain unchanged] */
        /* Base CSS Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            padding: 0.5em;
            background-color: #374244;
            color: #ffffff;
            margin: 0;
            font-size: 1.5em;
        }
        #colorContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5em;
        }
        .category {
            width: 100%;
            max-width: 1200px;
            margin: 0.5em 0;
            background-color: #ffffff;
            border-radius: 4px;
            box-sizing: border-box;
            padding: 0.5em;
            display: block; /* Ensure block display */
        }
        .category h2 {
            margin: 1em 0 0.5em 0;
            font-size: 1.2em;
            text-align: left;
            border-bottom: 1px solid #ccc;
            padding-bottom: 0.25em;
            display: block; /* Ensure block display */
            width: 100%; /* Ensure it takes full width */
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5em;
        }
        .color-item {
            display: flex;
            align-items: center;
            padding: 0.25em;
            background-color: #f9f9f9;
            border-radius: 4px;
            flex-wrap: wrap; /* Allow elements to wrap */
        }
        .color-name {
            flex: 1 1 100%; /* Allow full width */
            min-width: 0; /* Allows text to shrink */
            font-size: 0.9em;
            overflow-wrap: break-word; /* Break long words */
            margin-right: 0.25em;
            margin-bottom: 0.25em; /* Add margin below for spacing */
        }
        .controls-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls-container > * {
            flex: 0 0 auto;
            margin-right: 0.25em;
            margin-bottom: 0.25em; /* Add margin for wrapping */
        }
        .color-original,
        .arrow,
        .color-picker {
            width: 1.2em;
            height: 1.2em;
        }
        .hex-input {
            width: 5em;
            padding: 0.2em;
            font-size: 0.8em;
            border: 1px solid #cccccc;
            border-radius: 2px;
            text-transform: uppercase;
        }
        .reset-button {
            width: 1.2em;
            height: 1.2em;
            background: url('https://raw.githubusercontent.com/Dimserene/Trance-pallete-generator/main/reset.png') no-repeat center;
            background-size: contain;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 0.25em;
        }
        #resetAllButton,
        #exportLuaButton,
        #importLuaButton {
            display: inline-block;
            margin: 0.5em;
            padding: 0.5em 1em;
            font-size: 1em;
            background-color: #374244;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #resetAllButton:hover,
        #exportLuaButton:hover,
        #importLuaButton:hover {
            background-color: #4f6367;
        }
        #exportLuaOutput {
            width: calc(100% - 1em);
            max-width: 1200px;
            height: 250px;
            margin: 0.5em auto;
            display: block;
            font-family: monospace;
            padding: 0.5em;
            box-sizing: border-box;
            border: 1px solid #cccccc;
            border-radius: 4px;
            resize: vertical;
        }
        /* Mobile Styles */
        @media (max-width: 600px) {
            .category {
                padding: 0.25em;
                display: block; /* Ensure block display */
            }
            .category h2 {
                font-size: 1em;
                margin: 1em 0 0.25em 0; /* Add top margin */
                padding-bottom: 0.25em;
                display: block; /* Ensure block display */
                width: 100%; /* Ensure it takes full width */
            }
            .color-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.25em;
            }
            .color-item {
                padding: 0.25em;
                flex-wrap: wrap; /* Allow elements to wrap */
                align-items: center;
            }
            .color-name {
                font-size: 0.8em;
                margin-right: 0.25em;
                margin-bottom: 0.25em;
                flex: 1 1 100%;
                min-width: 0; /* Allows text to shrink */
            }
            .controls-container > * {
                margin-right: 0.25em;
                margin-bottom: 0.25em;
            }
            .color-original,
            .arrow,
            .color-picker,
            .reset-button {
                width: 1em;
                height: 1em;
            }
            .hex-input {
                width: 4em;
            }
            /* Remove margin-bottom from elements */
            .color-original,
            .arrow,
            .color-picker,
            .hex-input {
                margin-bottom: 0;
            }
            #resetAllButton,
            #exportLuaButton,
            #importLuaButton {
                margin: 0.25em;
                padding: 0.5em 1em;
            }
            #exportLuaOutput {
                height: 200px;
                margin: 0.25em auto;
            }
        }
    </style>
</head>
<body>

    <h1>Trance Palette Generator v1.2.1a</h1>

    <div id="colorContainer"></div>

    <div style="text-align: center;">
        <button id="resetAllButton">Reset All</button>
        <button id="exportLuaButton">Export Lua File</button>
        <input type="file" id="importLuaInput" accept=".lua" style="display: none;">
        <button id="importLuaButton">Import Lua File</button>
    </div>
    <textarea id="exportLuaOutput" placeholder="Updated colors in Lua format will appear here..."></textarea>

    <!-- Include jQuery (Spectrum dependency) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Spectrum JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>

    <!-- Your JavaScript code -->
    <script>
        // Original color data (deep copy to preserve defaults)
        const defaultColorData = [
            // [Your existing color data remains unchanged]
            // ...
            { key: 'SPLASH', value: ['FE5F55', '009DFF'] },
            { key: 'MULT', value: 'FE5F55' },
            { key: 'CHIPS', value: '009dff' },
            { key: 'PLASMA', value: 'cc73d9' },
            { key: 'MONEY', value: 'f3b958' },
            { key: 'XMULT', value: 'FE5F55' },
            { key: 'FILTER', value: 'ff9a00' },
            { key: 'BLUE', value: '009dff' },
            { key: 'RED', value: 'FE5F55' },
            { key: 'GREEN', value: '4BC292' },
            { key: 'PALE_GREEN', value: '56a887' },
            { key: 'ORANGE', value: 'fda200' },
            { key: 'IMPORTANT', value: 'ff9a00' },
            { key: 'GOLD', value: 'eac058' },
            { key: 'YELLOW', value: 'ffff00' },
            { key: 'CLEAR', value: '00000000' },
            { key: 'WHITE', value: 'ffffff' },
            { key: 'PURPLE', value: '8867a5' },
            { key: 'BLACK', value: '374244' },
            { key: 'L_BLACK', value: '4f6367' },
            { key: 'GREY', value: '5f7377' },
            { key: 'CHANCE', value: '4BC292' },
            { key: 'JOKER_GREY', value: 'bfc7d5' },
            { key: 'VOUCHER', value: 'cb724c' },
            { key: 'BOOSTER', value: '646eb7' },
            { key: 'ETERNAL', value: 'c75985' },
            { key: 'PERISHABLE', value: '4f5da1' },
            { key: 'RENTAL', value: 'b18f43' },
            {
                key: 'DYN_UI',
                value: [
                    { key: 'MAIN', value: '374244' },
                    { key: 'DARK', value: '374244' },
                    { key: 'BOSS_MAIN', value: '374244' },
                    { key: 'BOSS_DARK', value: '374244' },
                    { key: 'BOSS_PALE', value: '374244' }
                ]
            },
            {
                key: 'SO_1',
                value: [
                    { key: 'Hearts', value: 'f03464' },
                    { key: 'Diamonds', value: 'f06b3f' },
                    { key: 'Spades', value: '403995' },
                    { key: 'Clubs', value: '235955' }
                ]
            },
            {
                key: 'SO_2',
                value: [
                    { key: 'Hearts', value: 'f83b2f' },
                    { key: 'Diamonds', value: 'e29000' },
                    { key: 'Spades', value: '4f31b9' },
                    { key: 'Clubs', value: '008ee6' }
                ]
            },
            {
                key: 'UI',
                value: [
                    { key: 'TEXT_LIGHT', value: 'ffffff' },
                    { key: 'TEXT_DARK', value: '4F6367' },
                    { key: 'TEXT_INACTIVE', value: '88888899' },
                    { key: 'BACKGROUND_LIGHT', value: 'B8D8D8' },
                    { key: 'BACKGROUND_WHITE', value: 'ffffff' },
                    { key: 'BACKGROUND_DARK', value: '7A9E9F' },
                    { key: 'BACKGROUND_INACTIVE', value: '666666FF' },
                    { key: 'OUTLINE_LIGHT', value: 'D8D8D8' },
                    { key: 'OUTLINE_LIGHT_TRANS', value: 'D8D8D866' },
                    { key: 'OUTLINE_DARK', value: '7A9E9F' },
                    { key: 'TRANSPARENT_LIGHT', value: 'eeeeee22' },
                    { key: 'TRANSPARENT_DARK', value: '22222222' },
                    { key: 'HOVER', value: '00000055' }
                ]
            },
            {
                key: 'SET',
                value: [
                    { key: 'Default', value: 'cdd9dc' },
                    { key: 'Enhanced', value: 'cdd9dc' },
                    { key: 'Joker', value: '424e54' },
                    { key: 'Tarot', value: '424e54' },
                    { key: 'Planet', value: '424e54' },
                    { key: 'Spectral', value: '424e54' },
                    { key: 'Voucher', value: '424e54' }
                ]
            },
            {
                key: 'SECONDARY_SET',
                value: [
                    { key: 'Default', value: '9bb6bdFF' },
                    { key: 'Enhanced', value: '8389DDFF' },
                    { key: 'Joker', value: '708b91' },
                    { key: 'Tarot', value: 'a782d1' },
                    { key: 'Planet', value: '13afce' },
                    { key: 'Spectral', value: '4584fa' },
                    { key: 'Voucher', value: 'fd682b' },
                    { key: 'Edition', value: '4ca893' }
                ]
            },
            { key: 'RARITY', value: ['009dff', '4BC292', 'fe5f55', 'b26cbb'] },
            {
                key: 'BLIND',
                value: [
                    { key: 'Small', value: '50846e' },
                    { key: 'Big', value: '50846e' },
                    { key: 'Boss', value: 'b44430' },
                    { key: 'won', value: '4f6367' }
                ]
            },
            { key: 'HAND_LEVELS', value: ['efefef', '95acff', '65efaf', 'fae37e', 'ffc052', 'f87d75', 'caa0ef'] },
            {
                key: 'BACKGROUND',
                value: [
                    { key: 'L', value: 'ffff00' },
                    { key: 'D', value: '374244' },
                    { key: 'C', value: '374244' }
                ]
            },
            {
                key: 'BOSSES',
                value: [
                    { key: 'bl_ox', value: 'b95b08' },
                    { key: 'bl_hook', value: 'a84024' },
                    { key: 'bl_mouth', value: 'ae718e' },
                    { key: 'bl_fish', value: '3e85bd' },
                    { key: 'bl_club', value: 'b9cb92' },
                    { key: 'bl_manacle', value: '575757' },
                    { key: 'bl_tooth', value: 'b52d2d' },
                    { key: 'bl_wall', value: '8a59a5' },
                    { key: 'bl_house', value: '5186a8' },
                    { key: 'bl_mark', value: '6a3847' },
                    { key: 'bl_wheel', value: '50bf7c' },
                    { key: 'bl_arm', value: '6865f3' },
                    { key: 'bl_psychic', value: 'efc03c' },
                    { key: 'bl_goad', value: 'b95c96' },
                    { key: 'bl_water', value: 'c6e0eb' },
                    { key: 'bl_eye', value: '4b71e4' },
                    { key: 'bl_plant', value: '709284' },
                    { key: 'bl_needle', value: '5c6e31' },
                    { key: 'bl_head', value: 'ac9db4' },
                    { key: 'bl_window', value: 'a9a295' },
                    { key: 'bl_serpent', value: '439a4f' },
                    { key: 'bl_pillar', value: '7e6752' },
                    { key: 'bl_flint', value: 'e56a2f' },
                    { key: 'bl_final_bell', value: '009cfd' },
                    { key: 'bl_final_leaf', value: '56a786' },
                    { key: 'bl_final_vessel', value: '8a71e1' },
                    { key: 'bl_final_acorn', value: 'fda200' },
                    { key: 'bl_final_heart', value: 'ac3232' }
                ]
            }
        ];

        // Copy of color data that will be modified
        let colorData = JSON.parse(JSON.stringify(defaultColorData));

        // Store references to Spectrum instances
        const spectrumInstances = [];

        // [Your existing JavaScript code remains unchanged, including all functions and event listeners]

        // Function to create color pickers using Spectrum
        function createColorPickers(dataArray, container, defaultDataArray) {
            // [Function implementation remains the same]
            // ...
        }

        // Function to create category divs
        function createCategoryDiv(categoryObj, container) {
            // [Function implementation remains the same]
            // ...
        }

        // Function to create individual color items
        function createColorItem(colorValue, displayName, parentDataArray, dataIndex, container, defaultColorValue) {
            // [Function implementation remains the same]
            // ...
        }

        // Initialize the color pickers
        const colorContainer = document.getElementById('colorContainer');
        createColorPickers(colorData, colorContainer, defaultColorData);

        // Reset All functionality
        document.getElementById('resetAllButton').addEventListener('click', function() {
            // [Event listener implementation remains the same]
            // ...
        });

        // Export to Lua functionality
        document.getElementById('exportLuaButton').addEventListener('click', function() {
            const luaCode = 'return ' + convertToLuaTable(colorData);
            document.getElementById('exportLuaOutput').value = luaCode;

            // Trigger a download
            const blob = new Blob([luaCode], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'colors.lua';
            link.click();
        });

        // Import Lua functionality
        document.getElementById('importLuaButton').addEventListener('click', function() {
            document.getElementById('importLuaInput').click();
        });

        document.getElementById('importLuaInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const luaCode = e.target.result;
                    try {
                        const parsedData = parseLuaCode(luaCode);
                        // Update colorData
                        colorData = parsedData;
                        // Recreate the color pickers
                        colorContainer.innerHTML = '';
                        spectrumInstances.length = 0; // Clear existing instances
                        createColorPickers(colorData, colorContainer, defaultColorData);
                    } catch (error) {
                        alert('Error parsing Lua file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Function to parse the Lua code and extract color data
        function parseLuaCode(luaCode) {
            const ast = luaparse.parse(luaCode);
            // Extract the return statement
            if (ast.body.length > 0 && ast.body[0].type === 'ReturnStatement') {
                const returnStatement = ast.body[0];
                const argument = returnStatement.arguments[0];
                // Now parse the argument, which should be a table constructor
                const data = parseLuaTable(argument);
                return data;
            } else {
                throw new Error('No return statement found in Lua code.');
            }
        }

        function parseLuaTable(node) {
            if (node.type !== 'TableConstructorExpression') {
                throw new Error('Expected a table constructor.');
            }

            // Determine if the table is an array or an object
            const isArray = node.fields.every(field => field.type === 'TableValue');

            if (isArray) {
                // It's an array
                const result = [];
                node.fields.forEach(field => {
                    const valueNode = field.value;
                    const value = parseLuaValue(valueNode);
                    result.push(value);
                });
                return result;
            } else {
                // It's an object (table with key-value pairs)
                const result = [];
                node.fields.forEach(field => {
                    if (field.type === 'TableKeyString') {
                        const key = field.key.name;
                        const valueNode = field.value;
                        const value = parseLuaValue(valueNode);
                        result.push({ key: key, value: value });
                    } else {
                        throw new Error('Unsupported table field type: ' + field.type);
                    }
                });
                return result;
            }
        }

        function parseLuaValue(node) {
            if (node.type === 'StringLiteral') {
                return node.value;
            } else if (node.type === 'NumericLiteral') {
                return node.value;
            } else if (node.type === 'TableConstructorExpression') {
                return parseLuaTable(node);
            } else if (node.type === 'CallExpression') {
                // Handle HEX('...') function calls
                if (node.base.type === 'Identifier' && node.base.name === 'HEX') {
                    const arg = node.arguments[0];
                    if (arg.type === 'StringLiteral') {
                        return arg.value;
                    } else {
                        throw new Error('HEX function argument must be a string literal.');
                    }
                } else {
                    throw new Error('Unsupported function call: ' + node.base.name);
                }
            } else {
                throw new Error('Unsupported node type: ' + node.type);
            }
        }

        // Function to convert the array-based color data to Lua table format
        function convertToLuaTable(dataArray, indent = '', isRoot = true) {
            let lua = isRoot ? '{\n' : '{\n';
            const indent2 = indent + '    ';
            dataArray.forEach(item => {
                const key = item.key;
                const value = item.value;
                lua += indent2;
                if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
                    lua += key + ' = ';
                } else {
                    lua += '["' + key + '"] = ';
                }
                if (Array.isArray(value)) {
                    if (value.length > 0 && typeof value[0] === 'object') {
                        lua += convertToLuaTable(value, indent2, false) + ',\n';
                    } else if (value.length > 0 && (typeof value[0] === 'string' || typeof value[0] === 'number')) {
                        // Array of colors
                        lua += '{\n';
                        value.forEach(function(val) {
                            lua += indent2 + '    HEX(\'' + val + '\'),\n';
                        });
                        lua += indent2 + '},\n';
                    } else {
                        lua += 'nil,\n';
                    }
                } else if (typeof value === 'string') {
                    lua += 'HEX(\'' + value + '\'),\n';
                } else {
                    lua += 'nil,\n';
                }
            });
            lua += indent + '}';
            return lua;
        }
    </script>
</body>
</html>
